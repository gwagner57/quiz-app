<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Collection Export</title>
  <link rel="stylesheet" type="text/css" href="index.css">
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>

<script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

</head>
<body>
  <div class="container">
    <h1>Generate Quiz page</h1>
    <span>
      <p>Select category</p>
      <select id="categoryDropdown">
        <option value="">Select a category</option>
      </select>
    </span>
    <span>
    <p>Enter the number of question in the quiz page</p>
    <input type="text" id="Qs_nmbr" placeholder="Enter a value">
    </span>
    <span>
      <p>Enter the name of the quiz page</p>
      <input type="text" id="Qz_name" placeholder="Enter a value">
      </span>
    <button id="generateButton" disabled>Generate HTML&JSON</button>
    <button id="downloadButton">Download categories list</button>
    

  </div>
  <script type="module">
// Your web app's Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBz2zzn-yN-Qn5lk5ds2QMoDSr_OzHTThw",
    authDomain: "quiz-app-9f2e2.firebaseapp.com",
    databaseURL: "https://quiz-app-9f2e2-default-rtdb.firebaseio.com",
    projectId: "quiz-app-9f2e2",
    storageBucket: "quiz-app-9f2e2.appspot.com",
    messagingSenderId: "708478453138",
    appId: "1:708478453138:web:46f5e6d25826cbd15ded4b"
  };

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const collectionRef = db.collection('MoodleQuestions'); // Replace with your collection name

    collectionRef.get()
      .then((snapshot) => {
        const jsonData = [];
        snapshot.forEach((doc) => {
          jsonData.push(doc.data());
        });

        const categoryDropdown = document.getElementById('categoryDropdown');
        const categories = [...new Set(jsonData.map(item => item.category))]; // Get unique categories

        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categoryDropdown.appendChild(option);
        });
      
      
      
      
      
      
      })
      .catch((error) => {
        console.error('Error getting documents: ', error);
      });


let selectedQuestions = [];


    const categoryDropdown = document.getElementById('categoryDropdown');
    const generateButton = document.getElementById('generateButton');
    const Qs_nmbr = document.getElementById('Qs_nmbr');
    const Qz_name = document.getElementById('Qz_name');



// Function to reset the input field to its default value
function resetInput() {
    // Set the input field's value to an empty string or its initial/default value
    categoryDropdown.value = "";
    Qs_nmbr.value = "";
    Qz_name.value = "";
    generateButton.disabled = true;


}

// Call the resetInput function when the page loads (you can also use window.onload)
window.addEventListener("load", resetInput);











// Function to check if all three inputs have values and enable the button
function checkInputs() {
    if (categoryDropdown.value.trim() !== "" && Qs_nmbr.value.trim() !== "" && Qz_name.value.trim() !== "") {
      generateButton.disabled = false;
    } 
}

// Listen for input changes in the text fields
categoryDropdown.addEventListener("input", checkInputs);
Qs_nmbr.addEventListener("input", checkInputs);
Qz_name.addEventListener("input", checkInputs);
   



    generateButton.addEventListener('click', () => {
      const selectedCategory = categoryDropdown.value;
      if (selectedCategory && Qs_nmbr && Qz_name) {
        collectionRef.where('category', '==', selectedCategory).get(selectedQuestions)
          .then((snapshot) => {
            const categoryQuestions = [];
            snapshot.forEach((doc) => {
              categoryQuestions.push(doc.data());
            });
    const selectedQuestions = getRandomQuestions(categoryQuestions, parseInt(Qs_nmbr.value, 10));
    //console.log(selectedQuestions);
    const jsonString = JSON.stringify(selectedQuestions, null, 2);

    // Download the JSON file
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    //link.download = `${selectedCategory}_questions.json`;
    link.download = Qz_name.value +`.json`;
    link.click();












            async function generateHtml() {
            console.log(selectedQuestions);
            const jsonData2 = selectedQuestions;
            if (!jsonData2) {
            console.error('JSON data not available');
            return;
            }

            let html = `<!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <link rel="stylesheet" type="text/css" href="https://rawcdn.githack.com/gwagner57/quiz-app/main/data/css/Quiz.css?token=GHSAT0AAAAAACFSDHPJDOOMEFC4ISYF6TKUZIUPYKA">
              <title>quiz.title</title>
            </head>
            <body>
            <div class="container" id="container">
              <h1 id ="title">Quiz Title</h1>
              <script>
                 // Get the current URL
                const currentURL = window.location.href;

                  // Extract the file name from the URL
                  const fileName = currentURL.substring(currentURL.lastIndexOf('/')+1);
                  
                  // Decode any URL-encoded characters in the file name
                   const decodedFileName = decodeURIComponent(fileName);
    
                    const fileNameWithoutExtension = decodedFileName.substring(0, decodedFileName.lastIndexOf('.'));


                     // Display the file name inside the <h1> element
                   const fileNameDisplay = document.getElementById("title");
                   fileNameDisplay.textContent =  fileNameWithoutExtension;
                <\/script>`;

            jsonData2.forEach((questionData, index) => {
            const type = questionData.type;
            const questionText = questionData.questiontext[0].value;
            html += `<div id=q${index}>\n`;
            html += `${questionText}`;
        //console.log(type);

            if (type === 'shortanswer') {
            html += `<input type="text" name='${questionData.name[0].value}' />\n`;
              } else if (type === 'multichoice') {
                const answers = questionData.answer;
                answers.forEach(answer => {
                  html += `<input type="checkbox" name='${questionData.name[0].value}' value='${answer.value}' /> ${answer.value}<br>\n`;
                  //console.log(answer.value);
                });
              } else if (type === 'gapfill'){
                html += `<input type="txt" name='${questionData.name[0].value}' /> \n`;
              }

              html += `</div>\n`;

            });
            html += `<div id="Submitd"><button id="Submit">Submit</button></div>
            <div id="results-container"></div>
            <script>
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              
              document.addEventListener("DOMContentLoaded", function () {
    // Function to collect user inputs and checked checkboxes

const resultsContainer = document.getElementById('results-container');



function all(){

  
  

// Get the number of questions by counting the <div> elements with IDs q0, q1, q2, etc.
const numberOfQuestions = document.querySelectorAll('div[id^="q"]').length;

//console.log('Number of questions:', numberOfQuestions);







function collectUserInputs() {
  const userInputArrays = {}; // Object to store user inputs for each question ID

  // Iterate through each question div (q0, q1, q2, q3, q4, etc.)
  for (let i = 0; i <numberOfQuestions; i++) {
    const questionId = \`q\${i}\`;
    const questionDiv = document.getElementById(questionId);

    // Find all input elements within the question div
    const inputElements = questionDiv.querySelectorAll('input[type="txt"], input[type="text"], input[type="checkbox"]:checked');
    
     // Initialize an array for the current question ID
    userInputArrays[questionId] = [];



    // Iterate through the input elements and add them to the array
    inputElements.forEach((inputElement) => {
      const inputType = inputElement.type;
      const inputName = inputElement.name;
      const inputValue = inputElement.value;

      // Create an object to represent the input and add it to the array
      const userInput = {
        type: inputType,
        name: inputName,
        value: inputValue,
        Id: i,
      };

      userInputArrays[questionId].push(userInput);
    });
  }

  // Display the collected user inputs in the console
  //console.log(userInputArrays);
	return userInputArrays;
  // You can perform further processing or send the data to a server here
}


const userInputArrays = collectUserInputs();



//console.log(userInputArrays);
var originalURL = window.location.href;




// URL of the JSON file you want to load
const jsonFileURL = originalURL.replace(".html", ".json");

console.log(window.location.href);



// Function to fetch JSON data and return it as a Promise
function fetchJSONData(jsonFileURL) {
  return fetch(jsonFileURL)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    });
}
 //let score =0;



// Function to decode HTML entities
function decodeHTMLEntities(input) {
  const parser = new DOMParser();
  const decodedDocument = parser.parseFromString(input, 'text/html');
  return decodedDocument.documentElement.textContent;
}

fetchJSONData(jsonFileURL)
  .then(jsonData => {
    // Now you can use jsonData as the JSON data returned from the function
    //console.log(jsonData);
    //return jsonData;
    
    
    
    
		// Function to replace HTML entities
		function replaceHtmlEntities(data) {
		  if (typeof data === 'string') {
		    // Replace HTML entities with their corresponding symbols
		    data = data.replace(/&lt;/g, '<').replace(/&gt;/g, '>');
		  } else if (typeof data === 'object') {
		    // Recursively replace HTML entities in nested objects and arrays
		    for (const key in data) {
		      if (data.hasOwnProperty(key)) {
			data[key] = replaceHtmlEntities(data[key]);
		      }
		    }
		  }
		  return data;
		}

		// Replace HTML entities in the JSON data
		const convertedData = replaceHtmlEntities(jsonData);

		//console.log(convertedData);
    
    
    
    
    
    
    
    
    
    
    
    
  let score =[0];
   // let Id = userInputArray[0].Id;
   for (let i = 0; i <numberOfQuestions; i++){
    score.push(0);
   }
    convertedData.forEach(question => {
    const type = question.type;
    
    //console.log(type);
    if (type === 'multichoice'){
    const answers = question.answer;
    //console.log(answers);
    answers.forEach(answerr => {
    //console.log(question.name[0].value);
    //console.log(answer.attributes.fraction);
    //console.log(answerr.value);
    for (let i = 0; i <numberOfQuestions; i++) {
    const questionId = \`q\${i}\`; 
    const userInputArrayForQuestion = userInputArrays[questionId];
    if (userInputArrayForQuestion.length > 0) {
  	const firstName = userInputArrayForQuestion[0].name; // Access the name property of the first element
  	//console.log("Name of the first input for question", questionId, ":", firstName);
    
    
    
    if (userInputArrayForQuestion[0].name === question.name[0].value){
    console.log(userInputArrayForQuestion[0].name);
    for (let j = 0; j <userInputArrayForQuestion.length;j++){
     if(userInputArrayForQuestion[j].value === answerr.value){
     //console.log(userInputArray[i].value);
     //console.log(answerr.attributes.fraction);
     //console.log(answerr.attributes.fraction);
     score[i] += parseInt(answerr.attributes.fraction);
     console.log(score[i]);
     }}
     //else{
     //score[i] = parseInt(answerr.attributes.fraction);
     //}
     //Id = userInputArray[i].Id

     }
    
    
    
    
    
    
    
    
    } 
    else {
  	console.log("No user inputs for question", questionId);
    }
     
    //console.log(userInputArray[i].name)
    //console.log(question.name[0].value)
    } })

    }







    else if (type === 'shortanswer'){
      const answers = question.answer;
      //console.log(question.answer);
      answers.forEach(answerr => {
      //console.log(question.name[0].value);
      //console.log(answer.attributes.fraction);
      //console.log(answerr.value);
      for (let i = 0; i <numberOfQuestions; i++) {
      const questionId = \`q\${i}\`; 
      const userInputArrayForQuestion = userInputArrays[questionId];
      if (userInputArrayForQuestion.length > 0) {
      const firstName = userInputArrayForQuestion[0].name; // Access the name property of the first element
      //console.log("Name of the first input for question", questionId, ":", firstName);
      
      
      
      if (userInputArrayForQuestion[0].name === question.name[0].value){
      console.log(userInputArrayForQuestion[0].name);
      for (let j = 0; j <userInputArrayForQuestion.length;j++){
       if(userInputArrayForQuestion[j].value === answerr.value){
       //console.log(userInputArray[i].value);
       //console.log(answerr.attributes.fraction);
       //console.log(answerr.attributes.fraction);
       score[i] += parseInt(answerr.attributes.fraction);
       console.log(score[i]);
       }}
       //else{
       //score[i] = parseInt(answerr.attributes.fraction);
       //}
       //Id = userInputArray[i].Id
  
       }
      
      
      
      
      
      
      
      
      } 
      else {
      console.log("No user inputs for question", questionId);
      }
       
      //console.log(userInputArray[i].name)
      //console.log(question.name[0].value)
      } })
  
      }
    

    })

//});
    

  //console.log(Id);
                        console.log(score);
    
    
    let result = 0;
    for(let i=0; i <score.length; i++){
    if (score[i]>0){
      if (score[i] === 99){
        score[i] = 100;
      }
    result += score[i];
    }}
    
    const resultsPage = \`
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Quiz Results</title>
                <link rel="stylesheet" type="text/css" href="https://rawcdn.githack.com/gwagner57/quiz-app/main/data/css/Quiz_results.css?token=GHSAT0AAAAAACFSDHPIVJYJNPS5BC6GB5HUZIUQNOQ">
            </head>
            <body>
            <div class="container" id="container">
                <h1>Quiz Results</h1>
                <p>Your Score: \${result/100} Out of \${numberOfQuestions}</p>
                <!-- You can include more details about the results here -->
            </div>
            </body>
            </html>
        \`;

        // Open the results page in a new window/tab
        const resultsWindow = window.open('', '_blank');
        resultsWindow.document.open();
        resultsWindow.document.write(resultsPage);
        resultsWindow.document.close();


    
    
 
    
    
    
    
    
    
    
    
    
    
    
    
    

    // You can perform further processing with jsonData here
  })

  .catch(error => {
    console.error('There was a problem with the fetch operation:', error);
  });
































}
















// Add an event listener to the Submit button to trigger data collection
const submitButton = document.getElementById("Submit");
submitButton.addEventListener("click", all);

    
    
    
    
    
    
    
    
    
    
    
    
    
    /*
    const quizContainer = document.getElementById("container");
    const submitButton = document.getElementById("Submit");
    const element = document.querySelector('.container>h1');
    const jsonName = fileNameDisplay.textContent+".json";
    submitButton.addEventListener("click", async function () {
      const response = await fetch(jsonName); // Replace with the actual path to your JSON file
      const questions = await response.json();
      const userAnswers = [];
  	//console.log(questions);
      // Loop through the questions and collect user answers
      questions.forEach((question, index) => {
        const questionElement = quizContainer.querySelector(\`[name="q\${index}"]\`);
        if (question.type === "multichoice") {
            //console.log("questiontype = "+question.type);
          const selectedOption = quizContainer.querySelector(\`input[name="q\${index}"]:checked\`);
          console.log("radio ="+selectedOption);
          if (selectedOption) {
            userAnswers.push(selectedOption.value);
          } else {
            userAnswers.push(null);
          }
        } else {
          userAnswers.push(questionElement.value);
        }
      });
      
      console.log(userAnswers);

      /*
      console.log(userAnswers);
      // Compare user answers with correct answers and calculate score
      let score = 0;
      for (let i = 0; i < questions.length; i++) {
        if (questions[i].type === "multichoice") {
          if (userAnswers[i] === questions[i].correctAnswerIndex.toString()) {
            score++;
          }
        } else {
          if (userAnswers[i] === questions[i].correctAnswer.toString()) {
            score++;
          }
        }
      }
      // Display the results in another HTML page
      const resultPage = \`<html>
        <head>
          <title>Quiz Result</title>
          <link rel="stylesheet" href="../docs/Quiz.css" />
        </head>
        <body>
        <dev class="container">
          <h1>Your Quiz Result</h1>
          <p>You scored \${score} out of \${questions.length}.</p>
        </div>
        </body>
      </html>\`;
  
      // Open the result in a new window
      const resultWindow = window.open("", "_blank");
      resultWindow.document.write(resultPage);        */
    }); 
  //});
  
  
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
              <\/script>`;
            const blob2 = new Blob([html], { type: 'text/html' });
            const url2 = URL.createObjectURL(blob2);
            const link2 = document.createElement('a');
            link2.id = "test";
            link2.href = url2;
            link2.download = Qz_name.value +`.html`;
            link2.click();
          }



          generateHtml();

          
            //generateHtml();





















            
          })
          .catch((error) => {
            console.error('Error getting documents: ', error);
          });
      }
    });

    function getRandomQuestions(questions, count) {
  const shuffledQuestions = shuffleArray(questions); // Use a proper shuffle function
  return shuffledQuestions.slice(0, count);
}

// Fisher-Yates shuffle function
function shuffleArray(array) {
  const shuffledArray = array.slice(); // Create a copy of the array
  for (let i = shuffledArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledArray[i], shuffledArray[j]] = [shuffledArray[j], shuffledArray[i]];
  }
  return shuffledArray;
}


downloadButton.addEventListener('click', () => {
      const allOptions = categoryDropdown.querySelectorAll('option');
      const allOptionValues = [];

      allOptions.forEach((option) => {
        const optionValue = option.value.trim(); // Trim whitespace
        if (optionValue) {
          allOptionValues.push(optionValue);
        }
      });

      if (allOptionValues.length > 0) {
        // Combine all option values into one string
        const combinedOptions = allOptionValues.join('\n');

        // Create a Blob containing all option values
        const blob = new Blob([combinedOptions], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'Categories.txt';
        link.click();
      }
    });




</script>






</body>
</html>
